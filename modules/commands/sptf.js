const axios = require("axios");
const fs = require("fs");
const path = require("path");

module.exports.config = {
    name: "sptf",
        version: "1.0.0",
            hasPermssion: 0,
                credits: "DÅ©ngkon",
                    description: "TÃ¬m kiáº¿m vÃ  táº£i nháº¡c trÃªn spotify",
                        commandCategory: "Tiá»‡n Ã­ch",
                            usages: "search",
                                cooldowns: 5,
                                    dependencies: {
                                            "axios": "",
                                                    "fs": ""
                                                        }
                                                        };

                                                        module.exports.run = async function ({ api, event, args, Currencies, Users }) {
                                                            const { threadID, senderID, messageID } = event;
                                                                var data = await Currencies.getData(event.senderID);
                                                                    const out = (msg) => api.sendMessage(msg, threadID);

                                                                        if (!args.join(" ")) return out("Thiáº¿u TÃªn Nháº¡c TrÃªn Spotify");
                                                                            const search = args.join(" ");
                                                                                const attachments = [];
                                                                                    const dungkon = [];

                                                                                        try {
                                                                                                const res = (await axios.get(`https://sptf.dungkon.net/spotify/search?keywords=${encodeURIComponent(search)}`)).data;
                                                                                                        const data = res;

                                                                                                                if (!data || data.length === 0) {
                                                                                                                            return api.sendMessage("KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£ nÃ o.", threadID);
                                                                                                                                    }

                                                                                                                                            for (let i = 0; i < Math.min(10, data.length); i++) {
                                                                                                                                                        const video = data[i];
                                                                                                                                                                    const message = `ID: ${i + 1}.\nðŸ“TiÃªu Ä‘á»: ${video.title}\nTÃ¡c giáº£: ${video.author}\nKhoáº£ng thá»i gian: ${video.duration}\nâŠ± â‹… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â‹… âŠ°`;
                                                                                                                                                                                dungkon.push(message);

                                                                                                                                                                                            if (video.thumb) {
                                                                                                                                                                                                            const thumbPath = path.join(__dirname, `cache/${i + 1}.jpg`);
                                                                                                                                                                                                                            const response = await axios.get(video.thumb, { responseType: 'arraybuffer' });
                                                                                                                                                                                                                                            fs.writeFileSync(thumbPath, Buffer.from(response.data));
                                                                                                                                                                                                                                                            attachments.push(fs.createReadStream(thumbPath));
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                        // Gá»­i táº¥t cáº£ thÃ´ng tin vÃ  áº£nh trong má»™t láº§n
                                                                                                                                                                                                                                                                                                api.sendMessage(
                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                            body:"[TÃŒM KIáº¾M NHáº C TRÃŠN SPOTIFY]\n" + dungkon.join("\n\n") + "\n\nÂ» HÃ£y reply(pháº£n há»“i) chá»n má»™t trong nhá»¯ng tÃ¬m kiáº¿m trÃªn",
                                                                                                                                                                                                                                                                                                                                            attachment: attachments
                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                    threadID,
                                                                                                                                                                                                                                                                                                                                                                                (error, info) => {
                                                                                                                                                                                                                                                                                                                                                                                                global.client.handleReply.push({
                                                                                                                                                                                                                                                                                                                                                                                                                    name: module.exports.config.name,
                                                                                                                                                                                                                                                                                                                                                                                                                                        author: senderID,
                                                                                                                                                                                                                                                                                                                                                                                                                                                            messageID: info.messageID,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                result: data,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    attachment: attachments,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    api.sendMessage("Lá»—i: " + error.message, threadID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.error("ÄÃ£ xáº£y ra lá»—i:", error); // Log ra tÃ¬m lá»—i
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                module.exports.handleReply = async function ({ event, api, Currencies, Users, handleReply }) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { threadID, messageID, body, senderID } = event;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // Kiá»ƒm tra xem ngÆ°á»i reply cÃ³ pháº£i lÃ  ngÆ°á»i dÃ¹ng lá»‡nh khÃ´ng
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (senderID !== handleReply.author) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return api.sendMessage("Báº¡n khÃ´ng pháº£i ngÆ°á»i dÃ¹ng lá»‡nh", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const choose = parseInt(body.trim());

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                api.unsendMessage(handleReply.messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (isNaN(choose)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return api.sendMessage("âš ï¸ Vui lÃ²ng nháº­p 1 con sá»‘", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (choose > handleReply.result.length || choose < 1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return api.sendMessage("âŽ Lá»±a chá»n khÃ´ng náº±m trong danh sÃ¡ch", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const chosenVideo = handleReply.result[choose - 1];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        api.sendMessage(`${(await Users.getData(event.senderID)).name} vui lÃ²ng Ä‘á»£i`, event.threadID, (err, info) => setTimeout(() => { api.unsendMessage(info.messageID); }, 10000)); // tá»± Ä‘á»™ng gá»¡ tin nháº¯n sau 20 giÃ¢y 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const res = await axios.get(`https://sptf.dungkon.net/spotify/download?url=${encodeURIComponent(chosenVideo.link)}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            console.log(res)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const response = res.data.metadata;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const artists = response.artists;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const title = response.title;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const album = response.album;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const time = response.releaseDate

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const videoUrl = res.data.link;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!videoUrl) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return api.sendMessage("KhÃ´ng tÃ¬m tháº¥y URL video cháº¥t lÆ°á»£ng HD.", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // Kiá»ƒm tra dung lÆ°á»£ng video
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const headRes = await axios.head(videoUrl);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const contentLength = headRes.headers['content-length'];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (contentLength > 24 * 1024 * 1024) { // 24MB
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return api.sendMessage("Video vÆ°á»£t quÃ¡ dung lÆ°á»£ng 24MB vÃ  khÃ´ng thá»ƒ táº£i xuá»‘ng.", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const filePath = path.join(__dirname, `cache/${title.replace(/[^\w\s]/gi, '')}.mp3`);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const videoResponse = await axios.get(videoUrl, { responseType: "arraybuffer" });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fs.writeFileSync(filePath, Buffer.from(videoResponse.data));

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            api.sendMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        body: `[Táº¢I NHáº C TRÃŠN SPOTIFY]\nTiÃªu Ä‘á»: ${title}\nTÃ¡c giáº£: ${artists}\nAlbum: ${album}\nThá»i gian Ä‘Äƒng: ${time}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        attachment: fs.createReadStream(filePath)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                threadID,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (error, info) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (error) return console.error(error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            fs.unlinkSync(filePath);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    messageID
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.error("Error:", error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                api.sendMessage("ÄÃ£ xáº£y ra lá»—i khi táº£i video.", threadID, messageID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };